#!/bin/bash

chordlong=chordpro_long.json
usage="Usage: \e[1mchocomp\e[0m -h | [-l] \e[4mchofile\e[0m"
help="Compiler from chordpro/chordii files to pdf. Give an \".cho\"-file as argument.
$usage
	\e[1m-h\e[0m	Displays this message and exits.
	\e[1m-l\e[0m	Forces using configuration file for longer lyrics.
"
filename=
long=

die() {
  echo "$*"
  exit 1
}

while [[ -n "$1" ]]; do
  case $1 in
  -h)
    printf "$help"
    exit 0
    ;;
  -l)
    long=true
    ;;
  -*)
    printf "Wrong argument: %s\n$usage -- See -h for more help.\n" $1
    exit 1
    ;;
  *)
    if [[ "$1" != *.cho ]]; then
      echo "Please give a chordpro/chordii file to compile."
      exit 1
    fi
    if [[ ! -f "$1" ]]; then
      echo "File not found: $1"
      echo "Please give an existing and readable chordii file to compile."
      exit 1
    elif [[ ! -r "$1" ]]; then
      echo "File not readable: $1"
      echo "Please give an existing and readable chordii file to compile."
      exit 1
    fi
    filename=${1%.*}
    ;;
  esac
  shift
done

[[ -z "$filename" ]] && die "Please give a chordpro/chordii file to compile."

getPageNumber() {
  mdls -name kMDItemNumberOfPages "$1" | cut -d " " -f 3
}

if [[ ! -d pdf ]]; then
  mkdir pdf || die "Failed to create pdf/ dir."
fi

if [[ -n $(which chordpro) ]]; then
  if [[ -n $long ]]; then
    [[ ! -f "$chordlong" ]] && die "Configuation file for longer lyrics not found: $chordlong"
    echo "Using configuation file for longer lyrics."
    chordpro --config="$chordlong" -o pdf/"$filename".pdf "$filename".cho || die "Fail to print pdf from $filename."
  else
    chordpro -o pdf/"$filename".pdf "$filename".cho || die "Fail to print pdf from $filename."
    if [[ -f "$chordlong" && -n $(which mdls) ]]; then
      open -g pdf/"$filename".pdf && sleep 1
      pagenumber=$(getPageNumber pdf/"$filename".pdf)
      #echo "$pagenumber"
      if [[ -n $pagenumber && $pagenumber == 2 ]]; then
        echo "Well, that lyrics seems to be a little longer. Let try the json for long lyrics."
        chordpro --config="$chordlong" -o pdf/"$filename".pdf "$filename".cho || die "Fail to print pdf from $filename."
        open -g pdf/"$filename".pdf && sleep 1
        pagenumber=$(getPageNumber pdf/"$filename".pdf)
        #echo "$pagenumber"
        if [[ -n $pagenumber && $pagenumber == 2 ]]; then
          printf "That didn't work. Lyrics seems too long for one page."
          if [[ -z $long ]]; then
            echo " Reverting to default settings."
            chordpro -o pdf/"$filename".pdf "$filename".cho || die "Fail to print pdf from $filename."
          else
            echo
          fi
        fi
      fi
    fi
  fi
else
  echo "chordpro not found. Trying with chordii..."
  chordii -o "$filename".ps "$filename".cho || die "cho to ps conversion failed."
  pstopdf "$filename".ps pdf/"$filename".pdf || die "ps to pdf conversion failed."
  rm "$filename".ps || die "Could not remove ${filename}.ps"
fi

open pdf/"$filename".pdf|| die "Could not open pdf/${filename}.pdf"
