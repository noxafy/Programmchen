#!/bin/bash

usage="Usage: \e[1m$(basename $0)\e[0m -h | [\e[4mfile\e[0m]"
default_name="main.tex"
goal=
help="Compiles a tex file multiple times, so that bib and pdf are right. Uses pdflatexmkrc if available.
$usage
	\e[1m-h\e[0m	Display this message and exit.
	\e[4mfile\e[0m	.tex-file to compile (default: $default_name).
"

function die() {
  mes=$1
  shift
  [[ -n "$mes" ]] && printf "$mes\n" "$@"
  exit 1
}

function cltex() {
  local goal=$1
  [[ -z "$goal" && -e "main.tex" ]] && goal="main.tex"
  if [[ ! -e "$goal" || "$goal" != *.tex ]]; then
    echo "Please give a valid tex file." && return 1
  fi

  local -i removed=0
  local -a tokill=(aux bbl bcf blg dvi fdb_latexmk fls idx ilg ind lof log lot out out.ps run.xml spl toc xcp)
  for postfix in ${tokill[@]}; do
    local file="${goal:0:$((${#goal}-4))}.$postfix"
    [[ -e "$file" ]] && rm -v "$file" && ((removed++))
  done
  echo "$removed files removed"
}

function open_it() {
  if hash open &>/dev/null; then
    open "${1:0:$((${#1}-4))}.pdf"
  fi
  cltex "$1"
}

if [[ $1 = -* ]]; then
  if [[ $1 = -h ]]; then
    printf "$help"
    exit 0
  else
    die "Wrong argument: %s\n$usage -- See -h for more help.\n" "$1"
  fi
fi

goal="${1:-$default_name}"
[[ -n "$2" ]] && multiple=true || multiple=

if [[ -r "$PWD/pdflatexmkrc" ]]; then
  latexmk -pdf -r pdflatexmkrc "$goal" || die
  open_it "$goal"
elif [[ -n "$goal" ]]; then
  if [[ ! -r "$goal" ]]; then
    echo "Please give an existing and readable file. See -h for more help."
    exit 1
  fi
  latex -interaction=batchmode "$goal"
  if cat "$goal" | grep '^\\printbibliography' >/dev/null; then
    biber "${goal:0:$((${#goal}-4))}"
  else
    bibtex "${goal:0:$((${#goal}-3))}aux"
  fi
  latex -interaction=batchmode "$goal"
  latex -interaction=batchmode "$goal"
  pdflatex -interaction=batchmode "$goal"
  open_it "$goal"
else
 die "Please give a valid tex file. See -h for more help."
fi
