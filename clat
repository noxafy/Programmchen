#!/bin/bash

usage="Usage: \e[1m$(basename $0)\e[0m -h | \e[4mfiles\e[0m \e[4m...\e[0m"
help="Compiles one or multiple tex file multiple times, so bib and pdf is right.
$usage
	\e[1m-h\e[0m	Displays this message and exits.
	\e[4mfiles\e[0m	.tex-files which sould get compiled.
		Ensure existence of linked files (.aux, .bib, other .tex, ...)
"

function die() {
  mes=$1
  shift
  [[ -n "$mes" ]] && printf "$mes\n" "$@"
  exit 1
}

function open_it() {
  if hash open >/dev/null; then
    open "${1:0:$((${#1}-4))}.pdf"
  fi
}

if [[ $1 = -* ]]; then
  if [[ $1 = -h ]]; then
    printf "$help"
    exit 0
  else
    die "Wrong argument: %s\n$usage -- See -h for more help.\n" "$1"
  fi
fi

goal="${1:-main.tex}"
[[ -n "$2" ]] && multiple=true || multiple=

if [[ -r "$PWD/pdflatexmkrc" ]]; then
 latexmk -pdf -r pdflatexmkrc "$goal" || die
 open_it "$goal"
elif [[ -n "$goal" ]]; then
 if [[ ! -r "$1" ]]; then
  echo "Please give an existing and readable file. See -h for more help."
  exit 1
 fi
 for file in "$@"; do
   [[ -n $multiple ]] && echo "$file:"
   latex -interaction=batchmode "$file" || die
   if cat "$file" | grep '^\\printbibliography' >/dev/null; then
     biber "${file:0:$((${#file}-4))}" || die
   else
     bibtex "${file:0:$((${#file}-3))}aux" || die
   fi
   latex -interaction=batchmode "$file" || die
   latex -interaction=batchmode "$file" || die
   pdflatex -interaction=batchmode "$file"  || die
   open_it "$file"
 done
else
 die "Please give a valid tex file. See -h for more help."
fi
